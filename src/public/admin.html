<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - E-Commerce Premium</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #ffffff;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .header {
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(212, 175, 55, 0.2);
      padding: 25px 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #d4af37;
      font-size: 28px;
      font-weight: 700;
      text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }

    h2 {
      color: #ffffff;
      margin-bottom: 25px;
      font-size: 22px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary {
      background: rgba(212, 175, 55, 0.2);
      color: #d4af37;
      border: 1px solid rgba(212, 175, 55, 0.3);
    }

    .btn-primary:hover {
      background: rgba(212, 175, 55, 0.3);
      transform: translateY(-2px);
    }

    .btn-success {
      background: rgba(72, 187, 120, 0.2);
      color: #68d391;
      border: 1px solid rgba(72, 187, 120, 0.3);
    }

    .btn-success:hover {
      background: rgba(72, 187, 120, 0.3);
      transform: translateY(-2px);
    }

    .btn-warning {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .btn-warning:hover {
      background: rgba(251, 191, 36, 0.3);
    }

    .btn-danger {
      background: rgba(245, 101, 101, 0.2);
      color: #fc8181;
      border: 1px solid rgba(245, 101, 101, 0.3);
    }

    .btn-danger:hover {
      background: rgba(245, 101, 101, 0.3);
    }

    .tabs {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
    }

    .tab {
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(212, 175, 55, 0.2);
      padding: 18px 35px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      color: #a0a0b0;
      font-size: 15px;
    }

    .tab:hover {
      border-color: #d4af37;
      color: #d4af37;
    }

    .tab.active {
      background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      color: #0f0c29;
      border-color: #d4af37;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
    }

    .content-section {
      display: none;
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(212, 175, 55, 0.2);
      padding: 35px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .content-section.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }

    th, td {
      padding: 18px;
      text-align: left;
      border-bottom: 1px solid rgba(212, 175, 55, 0.1);
    }

    th {
      background: rgba(15, 12, 41, 0.6);
      font-weight: 700;
      color: #d4af37;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.5px;
    }

    td {
      color: #e0e0e0;
    }

    tr:hover {
      background: rgba(15, 12, 41, 0.3);
    }

    .badge {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-admin {
      background: rgba(212, 175, 55, 0.2);
      color: #d4af37;
      border: 1px solid rgba(212, 175, 55, 0.3);
    }

    .badge-user {
      background: rgba(96, 165, 250, 0.2);
      color: #60a5fa;
      border: 1px solid rgba(96, 165, 250, 0.3);
    }

    .badge-pending {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .badge-completed {
      background: rgba(72, 187, 120, 0.2);
      color: #68d391;
      border: 1px solid rgba(72, 187, 120, 0.3);
    }

    .filter-section {
      margin-bottom: 25px;
      display: flex;
      gap: 15px;
    }

    select {
      padding: 12px 18px;
      background: rgba(15, 12, 41, 0.6);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    select:focus {
      outline: none;
      border-color: #d4af37;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(26, 26, 46, 0.98);
      border: 1px solid rgba(212, 175, 55, 0.3);
      padding: 40px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-content h2 {
      color: #d4af37;
      margin-bottom: 25px;
    }

    .order-details {
      margin-top: 20px;
    }

    .order-details p {
      color: #e0e0e0;
      margin-bottom: 12px;
      font-size: 15px;
    }

    .order-details strong {
      color: #d4af37;
    }

    .product-item {
      padding: 15px;
      background: rgba(15, 12, 41, 0.6);
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid rgba(212, 175, 55, 0.1);
      color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚öôÔ∏è Panel de Administraci√≥n</h1>
      <div>
        <button class="btn btn-primary" onclick="window.location.href='index.html'">‚Üê Volver a productos</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('products')">üì¶ Productos</div>
      <div class="tab" onclick="switchTab('users')">üë• Usuarios</div>
      <div class="tab" onclick="switchTab('orders')">üõçÔ∏è Pedidos</div>
    </div>

    <!-- PRODUCTOS -->
    <div id="products" class="content-section active">
      <h2>Gesti√≥n de Productos</h2>
      <button class="btn btn-success" onclick="showProductForm()">+ Nuevo Producto</button>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="productsTable"></tbody>
      </table>
    </div>

    <!-- USUARIOS -->
    <div id="users" class="content-section">
      <h2>Gesti√≥n de Usuarios</h2>
      <table>
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <!-- PEDIDOS -->
    <div id="orders" class="content-section">
      <h2>Gesti√≥n de Pedidos</h2>
      <div class="filter-section">
        <select id="statusFilter" onchange="loadOrders()">
          <option value="">üîç Todos los estados</option>
          <option value="pending">‚è≥ En curso</option>
          <option value="completed">‚úÖ Completados</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Usuario</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="ordersTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal de detalle de pedido -->
  <div id="orderModal" class="modal">
    <div class="modal-content">
      <h2>üìã Detalle del Pedido</h2>
      <div id="orderDetails"></div>
      <button class="btn btn-primary" onclick="closeModal()" style="margin-top: 20px;">Cerrar</button>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');

    if (!token || user.role !== 'admin') {
      window.location.href = 'index.html';
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tab).classList.add('active');

      if (tab === 'users') loadUsers();
      if (tab === 'orders') loadOrders();
      if (tab === 'products') loadProducts();
    }

    async function loadUsers() {
      try {
        const response = await fetch('http://localhost:3000/api/users', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await response.json();
        
        document.getElementById('usersTable').innerHTML = users.map(u => `
          <tr>
            <td style="font-weight: 600;">${u.username}</td>
            <td><span class="badge badge-${u.role}">${u.role}</span></td>
            <td>
              <button class="btn btn-warning" onclick="changeRole('${u._id}', '${u.role === 'admin' ? 'user' : 'admin'}')">
                ‚ÜîÔ∏è Cambiar a ${u.role === 'admin' ? 'User' : 'Admin'}
              </button>
              <button class="btn btn-danger" onclick="deleteUser('${u._id}')">üóëÔ∏è Eliminar</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        alert('Error al cargar usuarios');
      }
    }

    async function changeRole(userId, newRole) {
      if (!confirm(`¬øCambiar rol a ${newRole}?`)) return;
      
      try {
        await fetch(`http://localhost:3000/api/users/${userId}/role`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ role: newRole })
        });
        loadUsers();
      } catch (error) {
        alert('Error al cambiar rol');
      }
    }

    async function deleteUser(userId) {
      if (!confirm('¬øEliminar este usuario?')) return;
      
      try {
        await fetch(`http://localhost:3000/api/users/${userId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        loadUsers();
      } catch (error) {
        alert('Error al eliminar usuario');
      }
    }

    async function loadOrders() {
      const status = document.getElementById('statusFilter')?.value;
      
      const query = status ? `
        query OrdersByStatus($status: String!) {
          ordersByStatus(status: $status) {
            id
            user { username }
            total
            status
            createdAt
            products { name quantity price }
          }
        }
      ` : `
        query AllOrders {
          orders {
            id
            user { username }
            total
            status
            createdAt
            products { name quantity price }
          }
        }
      `;

      try {
        const response = await fetch('http://localhost:3000/graphql', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            query,
            variables: status ? { status } : {}
          })
        });

        const result = await response.json();
        const orders = status ? result.data.ordersByStatus : result.data.orders;
        
        document.getElementById('ordersTable').innerHTML = orders.map(o => `
          <tr>
            <td style="font-weight: 600;">#${o.id.slice(-8).toUpperCase()}</td>
            <td>${o.user.username}</td>
            <td style="color: #d4af37; font-weight: 600;">${o.total.toFixed(2)}‚Ç¨</td>
            <td><span class="badge badge-${o.status}">${o.status === 'pending' ? 'En curso' : 'Completado'}</span></td>
            <td>${new Date(o.createdAt).toLocaleDateString('es-ES')}</td>
            <td>
              <button class="btn btn-primary" onclick='showOrderDetail(${JSON.stringify(o)})'>üëÅÔ∏è Ver</button>
              ${o.status === 'pending' ? `
                <button class="btn btn-success" onclick="updateOrderStatus('${o.id}', 'completed')">‚úÖ Completar</button>
              ` : ''}
            </td>
          </tr>
        `).join('');
      } catch (error) {
        alert('Error al cargar pedidos');
      }
    }

    function showOrderDetail(order) {
      const modal = document.getElementById('orderModal');
      const details = document.getElementById('orderDetails');
      
      details.innerHTML = `
        <div class="order-details">
          <p><strong>Pedido:</strong> #${order.id.slice(-8).toUpperCase()}</p>
          <p><strong>Usuario:</strong> ${order.user.username}</p>
          <p><strong>Estado:</strong> ${order.status === 'pending' ? '‚è≥ En curso' : '‚úÖ Completado'}</p>
          <p><strong>Fecha:</strong> ${new Date(order.createdAt).toLocaleString('es-ES')}</p>
          <h3 style="margin-top: 25px; color: #d4af37; margin-bottom: 15px;">Productos del pedido:</h3>
          ${order.products.map(p => `
            <div class="product-item">
              <strong>${p.name}</strong> - ${p.quantity} unidades √ó ${p.price.toFixed(2)}‚Ç¨ = <strong style="color: #d4af37;">${(p.quantity * p.price).toFixed(2)}‚Ç¨</strong>
            </div>
          `).join('')}
          <p style="margin-top: 25px; font-size: 20px;"><strong>Total del pedido:</strong> <span style="color: #d4af37; font-size: 24px;">${order.total.toFixed(2)}‚Ç¨</span></p>
        </div>
      `;
      
      modal.style.display = 'block';
    }

    async function updateOrderStatus(orderId, newStatus) {
      const mutation = `
        mutation UpdateOrderStatus($id: ID!, $status: String!) {
          updateOrderStatus(id: $id, status: $status) {
            id
            status
          }
        }
      `;

      try {
        await fetch('http://localhost:3000/graphql', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            query: mutation,
            variables: { id: orderId, status: newStatus }
          })
        });
        
        loadOrders();
      } catch (error) {
        alert('Error al actualizar pedido');
      }
    }

    function closeModal() {
      document.getElementById('orderModal').style.display = 'none';
    }

async function loadProducts() {
      // Usar GraphQL en lugar de REST
      const query = `
        query GetProducts {
          products {
            id
            name
            price
            stock
          }
        }
      `;

      try {
        const response = await fetch('http://localhost:3000/graphql', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ query })
        });

        const result = await response.json();
        
        if (result.errors) {
          throw new Error(result.errors[0].message);
        }

        const products = result.data.products;
        
        document.getElementById('productsTable').innerHTML = products.map(p => `
          <tr>
            <td style="font-weight: 600;">${p.name}</td>
            <td style="color: #d4af37; font-weight: 600;">${p.price}‚Ç¨</td>
            <td>${p.stock}</td>
            <td>
              <button class="btn btn-warning" onclick="editProduct('${p.id}')">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger" onclick="deleteProduct('${p.id}')">üóëÔ∏è Eliminar</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        alert('Error al cargar productos: ' + error.message);
      }
    }

    function showProductForm() {
      alert('Formulario de producto (implementar seg√∫n Pr√°ctica 1)');
    }

    loadProducts();
  </script>
</body>
</html>
